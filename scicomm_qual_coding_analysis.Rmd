---
title: "SciComm Qualitative Coding Analysis"
author: "Victoria"
date: "4/30/2020"
output: html_document
 df_print: paged
---
```{r data setup}
library(tidyverse)
#import coded sentences
lines<-read.csv("~/Documents/projects/scicomm_analysis_Arik/data/treatment_reflections_sentences_coded.csv",na.strings=c("","NA"))
```

```{r collapse sentences into single reflections}
#collapse into one student reflection per week (ex: a student who did all 5 should have 5 lines in df total)

codes<-
lines %>%
  select(-X, -sis_login_id, -section, group, -reflection_text, -group) %>%
  mutate_all(~replace(., is.na(.), 0)) %>% #replace NA with 0 for sum purposes
 group_by( id, response_no) %>% summarise_all(funs(sum)) 

#how many reflections have a theme occuring more than once (i.e. more than one sentence had a theme)?
codes %>%
  rowwise %>%
  mutate(numtwos = sum(c(neutral,negative, class_metacog, gaps_knowledge, comm_metacog, contextualize, positive, negative) > 1)) %>% #for theme columns, count how many have counts > 1
  group_by(response_no) %>%
  summarise(n = n(), 
            n_multiple_codes = sum(numtwos > 0)) %>% #totals by response
  summarise_all(funs(sum)) #gives overall total

```

```{r create presence/absence df}
#take collapsed dataframe and convert to yes/no to presence/absence of each theme 
codes_binary <-
codes %>%
  group_by(id, response_no) %>%
   mutate_if(is.numeric, ~1 * (. != 0)) #create a binary y/n whether they expressed that theme 
```

```{r sample size}
#sample size of reflections  and students 
lines %>%
  group_by(response_no) %>%
  summarise(n_sentences = n(), 
            n_students = n_distinct(id)) #%>%
  #summarise_all(funs(sum))  #run this line to get column totals. 
```

```{r count presence of themes across reflection}
#count of each "theme" across reflections 
codes_binary %>%
  select(-id) %>%
  group_by(response_no)%>%
  mutate(n_students = n())%>%
  group_by(response_no, n_students) %>%
  summarise_all(funs(sum)) %>%
  select(-id)

#need to convert to %s as seen in previous dataframes 
themes_percents<- 
  codes_binary %>%
    group_by(response_no) %>%
    summarise(n = n(),
              perc_neutral = (sum(neutral, na.rm = T)/n)*100, 
              perc_class_metacog = (sum(class_metacog , na.rm = T)/n)*100,
              perc_gaps_knowledge = (sum(gaps_knowledge,  na.rm = T)/n)*100, 
              perc_comm_metacog =  (sum(comm_metacog,  na.rm = T)/n)*100,
              perc_contextualize = (sum(contextualize,  na.rm = T)/n)*100, 
              perc_positive = (sum(positive,  na.rm = T)/n)*100,
              perc_negative = (sum(negative,  na.rm = T)/n)*100) 

#theme percents in long form for ggplots. 
theme_perc_long <- 
  themes_percents %>%
  select(-n) %>%
  pivot_longer(-response_no, names_to = "theme", values_to = "percent") %>%
  mutate(theme = gsub( "perc_", "", as.character(theme))) %>% #get rid of perc_ header in theme names 
  mutate_if(is.character, as.factor) #convert back to factor 
```

```{r theme plots assgn 1 2 4 }
#view assignments 1, 2, 4 as bar graphs 

#across assignments: 
theme_perc_long %>%
  filter(response_no %in% c(1,2,4)) %>%
  ggplot(aes(x = theme, y = percent, fill = as.factor(response_no))) + 
  geom_col(position = position_dodge(0.9)) + 
  facet_wrap(~ response_no)

#across themes: 
assgn124<-
  theme_perc_long %>%
  filter(response_no %in% c(1,2,4)) %>%
  filter(theme != "neutral") %>%
  ggplot(aes(x = as.factor(response_no), y = percent, fill = theme)) + 
  geom_col(position = position_dodge(0.9), color = "black") + 
  ylim(0,100)+ 
  scale_x_discrete(labels = c("Teach", "Tweet", "Creative/Art"))+ 
  labs(x = NULL, y = "Percent of responses where theme was present") + 
  facet_wrap(~ theme) + 
  plot_design + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

ggsave("~/Desktop/assgn124.png", assgn124, height = 7, width = 7, units = "in")
```

```{r theme plot assgn 1 3 5}
#theme plot for numbers 1, 3, 5 (teaching assignment)
#across themes: 
assgn135 <- 
  theme_perc_long %>%
  filter(response_no %in% c(1,3,5)) %>%
  filter(theme != "neutral") %>%
  ggplot(aes(x = as.factor(response_no), y = percent, fill = theme)) + 
  geom_col(position = position_dodge(0.9), color = "black") + 
  ylim(0,100)+ 
  scale_x_discrete(labels = c("1st", "2nd", "3rd"))+ 
  labs(x = "Time students completed teaching assignment", y = "Percent of responses where theme was present") + 
  facet_wrap(~ theme) + 
  plot_design + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")


  theme_perc_long %>%
  filter(response_no %in% c(1,3,5)) %>%
  filter(theme != "neutral") %>%
  ggplot(aes(x = response_no, y = percent, color = theme, fill = theme, group = theme)) + 
  geom_point() + 
  geom_line()+
  ylim(0,100)+ 
  scale_x_continuous(breaks = c(1,3,5), labels = c("1st", "2nd", "3rd"))+ 
  labs(x = "Time students completed teaching assignment", y = "Percent of responses where theme was present") + 
  plot_design + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
  
ggsave("~/Desktop/assgn124.png", assgn135, height = 7, width = 7, units = "in")

```
```{r}
library(lme4)
library(lmerTest)
library(nlme)

#create "time" variable (what was the "time students had seen the assignment?)
codes_binary<- codes_binary %>%
  mutate(time = case_when(
    response_no == 3 ~ 2, 
    response_no == 5 ~ 3, 
    TRUE ~ 1
  )) %>%
    mutate(assignment = case_when(
    response_no == 2 ~ "tweet", 
    response_no == 4 ~ "art", 
    TRUE ~ "teach"
  ))
  

#long form so that theme can be a variable
codes_bin_long<-
codes_binary %>%
  pivot_longer(neutral:negative, names_to = "theme", values_to = "present") 

codes_bin_long$theme<-as.factor(codes_bin_long$theme)
codes_bin_long$theme<-relevel(codes_bin_long$theme, "neutral")

teach<-codes_bin_long %>% filter(assignment == "teach")

#relationship between time and theme
m1<-glmer(present ~ theme*time +  (1|id), data=teach, family = "binomial") 
summary(m1)

#relationship between assignment and theme (first time)
assgn<-codes_bin_long %>% filter(time == 1)

m2<-glmer(present ~ theme*assignment +  (1|id), data=assgn, family = "binomial") 
summary(m2)

plot_model(m2, type = "pred", terms = c("theme", "assignment"), pred.type = "re")

pr <- ggpredict(m2, c("theme", "assignment"), type = "re")
plot(pr)

pr1 <- ggpredict(m1, c("theme", "time"), type = "re")
plot(pr1)
```


### Resoures used
[Count number of values in row using dplyr](https://stackoverflow.com/questions/37731987/count-number-of-values-in-row-using-dplyr)
[gsub for string split](https://stackoverflow.com/questions/14718203/removing-particular-character-in-a-column-in-r)




